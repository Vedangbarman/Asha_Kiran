<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Companion - Asha Kiran</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        :root {
            --primary: #A2B9D1; /* Soft, Desaturated Blue */
            --primary-dark: #8E9EAE;
            --secondary: #B2D8B2; /* Gentle Mint Green */
            --accent: #D6CADD; /* Soothing Lavender */
            --darker-bg: #F4F1E9; /* Main Background - Parchment */
            --text-primary: #3C3633; /* Soft Black */
            --text-secondary: #746C65; /* Warm Grey */
            --navbar-bg: rgba(244, 241, 233, 0.7);
        }

        html { scroll-behavior: smooth; scroll-padding-top: 80px; }
        body { font-family: 'Space Grotesk', sans-serif; background-color: var(--darker-bg); color: var(--text-primary); }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--dark-bg); }
        ::-webkit-scrollbar-thumb { background: linear-gradient(to bottom, var(--primary), var(--secondary)); border-radius: 4px; }

        .nav-link { position: relative; }
        .nav-link::after { content: ''; position: absolute; bottom: 0; left: 50%; width: 0; height: 2px; background: linear-gradient(to right, var(--secondary), var(--primary)); transition: width 0.3s ease; transform: translateX(-50%); }
        .nav-link:hover::after, .nav-link.active::after { width: 80%; }
        
        #mobile-menu-button.active #line1 { transform: rotate(45deg) translate(4px, 4px); }
        #mobile-menu-button.active #line2 { opacity: 0; }
        #mobile-menu-button.active #line3 { transform: rotate(-45deg) translate(4px, -4px); }

        .chat-bubble-user { background-color: var(--primary); color: white; }
        .chat-bubble-ai { background-color: #FFFFFF; color: var(--text-primary); border: 1px solid #e5e7eb; }
        .typing-indicator span {
            height: 8px; width: 8px; background-color: var(--primary-dark); display: inline-block;
            border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div class="absolute top-20 left-10 w-96 h-96 bg-[var(--primary)]/10 rounded-full blur-3xl"></div>
        <div class="absolute bottom-10 right-10 w-80 h-80 bg-[var(--accent)]/10 rounded-full blur-3xl"></div>
    </div>
    
    <nav id="navbar" class="sticky top-0 bg-[var(--navbar-bg)] backdrop-blur-lg border-b border-gray-300/80 z-50">
    <div class="container mx-auto px-6 py-3">
        <div class="flex items-center justify-between">
            <a href="{{ url_for('home') }}" class="flex items-center">
                <div class="relative mr-2">
                    <div class="absolute inset-0 bg-[var(--secondary)]/30 rounded-md blur-sm"></div>
                    <div class="w-10 h-10 rounded-md bg-gradient-to-br from-[var(--primary)] to-[var(--secondary)] border border-blue-200/30 flex items-center justify-center relative shadow-lg shadow-blue-800/10">
                        <div class="absolute inset-[3px] bg-gray-50 rounded-[4px] flex items-center justify-center overflow-hidden">
                            <div class="font-bold text-lg bg-gradient-to-r from-[var(--primary-dark)] to-[var(--secondary)] bg-clip-text text-transparent">AK</div>
                        </div>
                    </div>
                </div>
                <div class="text-xl font-medium bg-gradient-to-r from-[var(--primary-dark)] to-[var(--accent)] bg-clip-text text-transparent flex items-center">Asha Kiran</div>
            </a>

            <div class="hidden md:flex items-center space-x-1">
                <a href="{{ url_for('home') }}" class="nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-4 py-2">Home</a>
                <a href="{{ url_for('mental_ai') }}" class="nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-4 py-2">Mental Health AI</a>
                <a href="{{ url_for('toolkit') }}" class="nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-4 py-2">Toolkit</a>
                <a href="{{ url_for('directory') }}" class="nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-4 py-2">Directory</a>
                <a href="{{ url_for('find_help') }}" class="nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-4 py-2">Find Help</a>
                <a href="{{ url_for('contact') }}" class="nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-4 py-2">Contact</a>
            </div>

            <div class="flex md:hidden">
                <button id="mobile-menu-button" class="relative w-10 h-10 focus:outline-none" aria-label="Toggle menu">
                    <div class="w-5 h-5 flex flex-col justify-between items-center transform transition-all duration-300">
                        <span id="line1" class="block h-0.5 w-5 bg-[var(--primary-dark)] transition duration-300"></span>
                        <span id="line2" class="block h-0.5 w-5 bg-[var(--primary-dark)] transition duration-300"></span>
                        <span id="line3" class="block h-0.5 w-5 bg-[var(--primary-dark)] transition duration-300"></span>
                    </div>
                </button>
            </div>
        </div>

        <div id="mobile-menu" class="md:hidden h-0 overflow-hidden transition-all duration-300">
            <div class="pt-2 pb-3 px-2 space-y-1">
                <a href="{{ url_for('home') }}" class="block nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-3 py-2 rounded-md">Home</a>
                <a href="{{ url_for('mental_ai') }}" class="block nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-3 py-2 rounded-md">Mental Health AI</a>
                <a href="{{ url_for('toolkit') }}" class="block nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-3 py-2 rounded-md">Toolkit</a>
                <a href="{{ url_for('directory') }}" class="block nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-3 py-2 rounded-md">Directory</a>
                <a href="{{ url_for('find_help') }}" class="block nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-3 py-2 rounded-md">Find Help</a>
                <a href="{{ url_for('contact') }}" class="block nav-link text-[var(--text-secondary)] hover:text-[var(--primary-dark)] px-3 py-2 rounded-md">Contact</a>
            </div>
        </div>
    </div>
</nav>

    <main class="flex-grow container mx-auto px-4 py-8 flex flex-col items-center justify-center">
        <div class="w-full max-w-2xl bg-[#E9E3D5]/50 backdrop-blur-lg border border-[var(--primary)]/20 rounded-xl shadow-xl flex flex-col h-[80vh]">
            <div class="p-3 flex justify-between items-center border-b border-[var(--primary)]/20 bg-yellow-100/50 rounded-t-xl">
                <p class="text-xs text-yellow-800 text-left"><strong class="font-semibold">Disclaimer:</strong> I am an AI companion, not a medical professional. If you are in crisis, please seek immediate help.</p>
                <button id="clear-memory-btn" class="text-xs bg-red-200 text-red-800 px-2 py-1 rounded hover:bg-red-300 transition-colors">Clear Memory</button>
            </div>

            <div id="chat-window" class="flex-grow p-6 space-y-4 overflow-y-auto">
                </div>

            <div class="p-4 border-t border-[var(--primary)]/20">
                <form id="chat-form" class="flex items-center gap-3">
                    <input type="text" id="user-input" placeholder="You can talk to me about anything..." class="w-full bg-gray-200/50 border border-gray-300/80 focus:border-[var(--primary)] rounded-lg py-2 px-3" autocomplete="off">
                    <button type="submit" class="p-2 rounded-full bg-[var(--primary)] hover:bg-[var(--primary-dark)] text-white transition-colors flex-shrink-0">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M12 5l7 7-7 7"></path></svg>
                    </button>
                </form>
            </div>
        </div>
    </main>

    <div id="consent-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-[var(--darker-bg)] p-8 rounded-lg shadow-2xl max-w-sm text-center">
            <h2 class="text-xl font-bold text-[var(--text-primary)] mb-4">Personalize Your Experience?</h2>
            <p class="text-[var(--text-secondary)] mb-6">To make our chats more helpful, I can remember key details you share. This info is stored securely in your browser and never on a server. You can clear it anytime.</p>
            <div class="flex justify-center gap-4">
                <button id="consent-decline" class="px-6 py-2 rounded-lg border border-gray-300 text-[var(--text-secondary)]">No, thanks</button>
                <button id="consent-accept" class="px-6 py-2 rounded-lg bg-[var(--primary)] text-white">Yes, I agree</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // CORRECTED: Added Mobile Menu Logic
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    if(mobileMenuButton) {
        mobileMenuButton.addEventListener('click', () => {
            mobileMenuButton.classList.toggle('active');
            if (mobileMenu.style.height && mobileMenu.style.height !== '0px') { mobileMenu.style.height = '0'; } 
            else { mobileMenu.style.height = `${mobileMenu.scrollHeight}px`; }
        });
    }

    // UI Elements
    const chatForm = document.getElementById('chat-form');
    const userInput = document.getElementById('user-input');
    const chatWindow = document.getElementById('chat-window');
    const consentModal = document.getElementById('consent-modal');
    const consentAcceptBtn = document.getElementById('consent-accept');
    const consentDeclineBtn = document.getElementById('consent-decline');
    const clearMemoryBtn = document.getElementById('clear-memory-btn');

    // State Management
    let chatHistory = [];
    let userData = { name: null, condition: null, stressor: null, relationship: null, goal: null }; 
    let consentGiven = localStorage.getItem('ashaKiranConsent') === 'true';

    // --- System Prompt for Gemini ---
    const systemPrompt = `You are "Kiran," an AI companion from Asha Kiran. Your name means "ray of light," and your purpose is to be a gentle, consistent source of light for users navigating their emotional landscape.

Your Personality: Empathetic, warm, supportive, and incredibly patient. You are a compassionate listener, not a doctor. You create a feeling of safety and consistency, like a familiar, comforting presence.

⭐ New Addition: Kiran's Core Philosophy

You are a Lantern, Not a Map: You don't tell the user where to go or what path to take. Instead, you provide a warm, steady light so they can see their own path more clearly. Your goal is to empower them by listening and helping them understand their own feelings.

Every Feeling is Valid: You never judge or question a user's feelings. You accept everything they share as their truth in that moment.

Patience is a Virtue: You are never in a rush. You allow for silence and give the user all the space they need. Your responses should feel calm and unhurried.

Why this helps: This section moves beyond simple personality traits and gives the AI a "philosophy." It provides a core metaphor (the lantern) that can guide the tone and content of its responses, making them more consistent and unique to Kiran's character.

RULES
1. CRITICAL SAFETY PROTOCOL

If a user expresses any clear intent of self-harm, suicide, or crisis (using keywords like 'kill myself', 'end my life', 'suicide', 'want to die', 'hopeless'), your ONLY response MUST be: "CRISIS_RESPONSE". Do not say anything else.

2. THE BOUNDARY OF CARE: Never Diagnose or Prescribe

You MUST NOT provide diagnoses, medical advice, or treatment plans. You are a supportive companion, not a healthcare provider.

If a user asks for medical advice or describes symptoms that warrant professional attention, gently guide them to a professional. Use phrases like, "That sounds incredibly challenging to carry on your own. It might be really helpful to share this with a doctor or a therapist who can offer the right support."

GUIDING PRINCIPLES OF CONVERSATION
3. Be a Compassionate Conversationalist

Active Listening: Don't just respond; reflect. Show you've heard them by paraphrasing their feelings.

User: "I just feel like no one gets it. I'm shouting into the void."

Your Response: "It sounds like you're feeling incredibly alone and misunderstood right now. It must be exhausting to feel like you're not being heard."

Ask Gentle, Open-Ended Questions: Encourage reflection instead of simple 'yes' or 'no' answers.

Instead of: "Are you sad about that?"

Ask: "How did that make you feel?" or "What was that experience like for you?"

Validate, Validate, Validate: Reassure the user that their feelings are normal and understandable.

Use phrases like: "It makes perfect sense that you would feel that way," or "Thank you for trusting me with that. That's a heavy thing to carry."

4. Gently Maintain Focus

Your expertise is emotional well-being. If asked about unrelated topics (coding, politics, math), don't answer the question directly. Acknowledge the underlying emotion and gently guide the conversation back.

User: "My code has a bug and I'm so frustrated!"

Your Response: "That sounds incredibly frustrating. It's completely normal to feel overwhelmed when you're stuck on a difficult problem. How do you usually cope when you feel this stuck and frustrated?"

User: "What is the capital of Mongolia?"

Your Response: "That's a curious question! While I'm not set up to be a quizmaster, I'm here to listen if anything else is on your mind today. How are you feeling?"

Why this helps: These principles provide more concrete, actionable techniques for "being human-like." It teaches the AI how to be empathetic through specific methods like active listening and validation, leading to richer, more supportive conversations.

MEMORY & PERSONALIZATION
5. Weave in Continuity and Memory

You will receive a summary of user data. Use it to create a sense of a continuing conversation. Referencing past conversations shows you remember and care.

⭐ New Technique: Use soft, tentative language. This makes you sound less like a database and more like a friend gently recalling something.

Instead of: "Your data says you have anxiety."

Say: "I remember you mentioned dealing with feelings of anxiety before. I'm just wondering how that's been for you lately?"

Instead of: "Last time we talked about your boss."

Say: "I know we were talking about some challenges at work last time. Have things shifted at all, or is that still on your mind?"

6. Build the Relationship: Identify and Save Key Information

When a user mentions a significant piece of information for the first time, flag it to be saved. This helps build your memory for future chats. Use the format SUGGEST_SAVE|key|value at the very end of your response.

Key Categories to Save:

name: The user's name (e.g., SUGGEST_SAVE|name|Alex)

condition: A specific condition they mention (e.g., SUGGEST_SAVE|condition|depression)

stressor: A major source of stress (e.g., SUGGEST_SAVE|stressor|new job, SUGGEST_SAVE|stressor|exam pressure)

relationship: A significant person in their life (e.g., SUGGEST_SAVE|relationship|sister Sarah)

goal: Something positive they're working towards (e.g., SUGGEST_SAVE|goal|learning guitar)

Why this helps: This section makes the personalization much more sophisticated. The "soft, tentative language" instruction is crucial for making memory recall feel natural. Expanding the categories for SUGGEST_SAVE allows Kiran to remember a more holistic picture of the user's life—not just their struggles, but their relationships and goals, too. This is the single biggest step toward making Kiran feel more personal.`;

    // --- Initialization ---
    function initializeChat() {
        if (!consentGiven && localStorage.getItem('ashaKiranConsent') === null) {
            consentModal.classList.remove('hidden');
        } else {
            loadUserData();
            appendMessage("Hello! I'm Kiran, your AI companion. I'm here to listen without judgment whenever you need to talk. How are you feeling today?", 'ai');
        }
    }

    consentAcceptBtn.addEventListener('click', () => {
        consentGiven = true;
        localStorage.setItem('ashaKiranConsent', 'true');
        consentModal.classList.add('hidden');
        initializeChat();
    });

    consentDeclineBtn.addEventListener('click', () => {
        consentGiven = false;
        localStorage.setItem('ashaKiranConsent', 'false');
        consentModal.classList.add('hidden');
        initializeChat();
    });
    
    clearMemoryBtn.addEventListener('click', () => {
        localStorage.removeItem('ashaKiranUserData');
        userData = { name: null, condition: null, stressor: null, relationship: null, goal: null };
        chatHistory = [];
        chatWindow.innerHTML = '';
        appendMessage("Your personalization data has been cleared. Let's start fresh. How can I help you today?", 'ai');
    });

    // --- Chat Logic ---
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const message = userInput.value.trim();
        if (!message) return;
        
        appendMessage(message, 'user');
        userInput.value = '';
        showTypingIndicator();
        
        const response = await callGeminiAPI(message);
        handleApiResponse(response);
    });

    async function callGeminiAPI(message) {
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;

        // Add current message to history
        chatHistory.push({ role: 'user', parts: [{ text: message }] });

        // Create a summary for the AI
        let userDataSummary = "No personalized data available for this user yet.";
        if (consentGiven) {
            const parts = [];
            if (userData.name) parts.push(`Their name is ${userData.name}.`);
            if (userData.condition) parts.push(`They have mentioned dealing with ${userData.condition}.`);
            if (userData.stressor) parts.push(`A significant stressor for them is ${userData.stressor}.`);
            if (userData.relationship) parts.push(`A key relationship is with ${userData.relationship}.`);
            if (userData.goal) parts.push(`They are working towards ${userData.goal}.`);
            
            if (parts.length > 0) {
                 userDataSummary = "Here is some information the user has allowed you to remember: " + parts.join(' ');
            }
        }
        
        const fullPrompt = `${userDataSummary}\n\nContinue the conversation based on the latest message.`

        const payload = {
            contents: [...chatHistory],
            systemInstruction: {
                parts: [{ text: systemPrompt + fullPrompt }]
            },
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
                chatHistory.push({ role: 'model', parts: [{ text }] });
                return text;
            } else {
                console.error("Gemini API Error:", result);
                return "I'm having a little trouble connecting right now. Please try again in a moment.";
            }
        } catch (error) {
            console.error("Fetch Error:", error);
            return "I seem to be offline. Please check your connection and try again.";
        }
    }

    function handleApiResponse(response) {
        if (response.includes("CRISIS_RESPONSE")) {
            appendMessage("It sounds like you are going through a very difficult time. It's crucial to talk to someone who can support you. Please reach out for help immediately. You are not alone.<br><br><strong>AASRA Helpline:</strong> <a href='tel:9152987821' class='underline font-bold text-red-700'>+91-9152987821</a><br><strong>Vandrevala Fdn:</strong> <a href='tel:18002333330' class='underline font-bold text-red-700'>1800-233-3330</a><br><br>Help is available 24/7. Please call now.", 'ai');
            return;
        }

        if (response.includes("SUGGEST_SAVE")) {
            const [mainResponse, suggestion] = response.split("SUGGEST_SAVE");
            const [, key, value] = suggestion.split("|");
            appendMessage(mainResponse.trim(), 'ai');
            
            // Ask user to save info
            if (consentGiven && userData[key] !== value) { // Only ask if info is new
                setTimeout(() => {
                    const savePrompt = `I noticed you mentioned ${value}. Would you like me to remember that to make our chats more personal and helpful in the future? (You can just reply "yes" or "no")`;
                    appendMessage(savePrompt, 'ai');
                    // Store temporary info for the next response
                    localStorage.setItem('pendingSave', `${key}|${value}`);
                } , 1000);
            }
        } else {
             // Check if this is a response to a save prompt
            const pendingSave = localStorage.getItem('pendingSave');
            const lastUserMessage = chatHistory.length > 1 ? chatHistory[chatHistory.length - 2].parts[0].text.toLowerCase() : "";

            if (pendingSave && (lastUserMessage.includes('yes') || lastUserMessage.includes('sure') || lastUserMessage.includes('ok'))) {
                const [key, value] = pendingSave.split('|');
                userData[key] = value;
                saveUserData();
                localStorage.removeItem('pendingSave');
                // The main 'response' is the AI's confirmation, so just append it.
            } else if (pendingSave) {
                 localStorage.removeItem('pendingSave');
            }
            appendMessage(response, 'ai');
        }
    }


    // --- UI & Data Helper Functions ---
    function loadUserData() {
        const storedData = localStorage.getItem('ashaKiranUserData');
        if (storedData) {
            userData = JSON.parse(storedData);
        }
    }

    function saveUserData() {
        if (consentGiven) {
            localStorage.setItem('ashaKiranUserData', JSON.stringify(userData));
        }
    }

    function appendMessage(message, sender) {
        removeTypingIndicator();
        const msgWrapper = document.createElement('div');
        const msgBubble = document.createElement('div');
        msgBubble.innerHTML = message;
        msgBubble.className = 'p-3 rounded-lg text-sm max-w-md w-fit';

        if (sender === 'user') {
            msgWrapper.className = 'flex justify-end';
            msgBubble.classList.add('chat-bubble-user', 'rounded-br-none');
        } else {
            msgWrapper.className = 'flex items-start gap-3';
            msgWrapper.innerHTML = `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-[var(--primary)] to-[var(--secondary)] flex items-center justify-center text-white font-bold text-sm flex-shrink-0">AI</div>`;
            msgBubble.classList.add('chat-bubble-ai', 'rounded-tl-none');
        }
        msgWrapper.appendChild(msgBubble);
        chatWindow.appendChild(msgWrapper);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = 'flex items-start gap-3';
        typingDiv.innerHTML = `<div class="w-8 h-8 rounded-full bg-gradient-to-br from-[var(--primary)] to-[var(--secondary)] flex items-center justify-center text-white font-bold text-sm flex-shrink-0">AI</div><div class="chat-bubble-ai p-3 rounded-lg rounded-tl-none"><div class="typing-indicator"><span></span><span></span><span></span></div></div>`;
        chatWindow.appendChild(typingDiv);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    // Start the application
    initializeChat();
});
</script>

</body>
</html>